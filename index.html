import React, { useState, useEffect, useRef } from 'react';
import { 
  Calendar, 
  Clock, 
  User, 
  Briefcase, 
  Trash2, 
  Edit2, 
  Download, 
  PieChart, 
  Plus, 
  Save, 
  Copy, 
  Check,
  TrendingUp
} from 'lucide-react';

// --- Utility Functions ---

const generateId = () => Math.random().toString(36).substr(2, 9);

const formatDate = (dateString) => {
  if (!dateString) return '';
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(dateString).toLocaleDateString(undefined, options);
};

const supervisors = [
  { name: 'Diane Flitcroft', email: 'dflitcroft@saintbernadette.com' },
  { name: 'Ashley Kaschl', email: 'akaschl@popejohnxxiii.org' }
];

// --- Main Component ---

export default function ServiceLogger() {
  // State
  const [entries, setEntries] = useState([]);
  const [view, setView] = useState('log'); // 'log', 'history', 'stats'
  
  // Default org set to Saint Bernadette Catholic Church
  const [formData, setFormData] = useState({
    id: '',
    type: '', // We keep 'type' internally for backward compatibility, but label it Description
    hours: '',
    date: new Date().toISOString().split('T')[0],
    org: 'Saint Bernadette Catholic Church',
    supervisor: supervisors[0].email
  });
  const [editingId, setEditingId] = useState(null);
  const [copiedEmail, setCopiedEmail] = useState(null);
  const [notification, setNotification] = useState(null);

  // Suggestions derived from history
  const typeSuggestions = [...new Set(entries.map(e => e.type))];
  const orgSuggestions = [...new Set(entries.map(e => e.org))];

  // Load data on mount
  useEffect(() => {
    const savedData = localStorage.getItem('service-hours-data');
    if (savedData) {
      try {
        setEntries(JSON.parse(savedData));
      } catch (e) {
        console.error("Failed to load data", e);
      }
    }
  }, []);

  // Save data on change
  useEffect(() => {
    localStorage.setItem('service-hours-data', JSON.stringify(entries));
  }, [entries]);

  // Notification Helper
  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  // Form Handlers
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSupervisorSelect = (email) => {
    setFormData(prev => ({ ...prev, supervisor: email }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.hours || !formData.date || !formData.org || !formData.type) {
      showNotification("Please fill in all required fields.");
      return;
    }

    const entry = {
      ...formData,
      id: editingId || generateId(),
      hours: parseFloat(formData.hours)
    };

    if (editingId) {
      setEntries(entries.map(item => item.id === editingId ? entry : item));
      setEditingId(null);
      showNotification("Entry updated successfully!");
    } else {
      setEntries([entry, ...entries]);
      showNotification("Hours logged successfully!");
    }

    // Reset form, maintaining default org
    setFormData({
      id: '',
      type: '',
      hours: '',
      date: new Date().toISOString().split('T')[0],
      org: 'Saint Bernadette Catholic Church',
      supervisor: supervisors[0].email
    });
  };

  const handleEdit = (entry) => {
    setFormData({
      ...entry,
      supervisor: entry.supervisor // Ensure supervisor email matches
    });
    setEditingId(entry.id);
    setView('log');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleDelete = (id) => {
    if (window.confirm("Are you sure you want to delete this entry?")) {
      setEntries(entries.filter(e => e.id !== id));
      showNotification("Entry deleted.");
    }
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text);
    setCopiedEmail(text);
    setTimeout(() => setCopiedEmail(null), 2000);
  };

  // Export Data
  const exportCSV = () => {
    // Updated header from Service Type to Description
    const headers = ["Date", "Description", "Organization", "Hours", "Supervisor Name", "Supervisor Email"];
    const rows = entries.map(e => {
      const sup = supervisors.find(s => s.email === e.supervisor) || { name: 'Unknown', email: e.supervisor };
      return [
        e.date,
        `"${e.type}"`, // Quote strings to handle commas
        `"${e.org}"`,
        e.hours,
        sup.name,
        sup.email
      ].join(",");
    });

    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `service_hours_export_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Statistics Calculations
  const totalHours = entries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
  
  // Chart Data Preparation (Group by Month)
  const getChartData = () => {
    const months = {};
    entries.forEach(entry => {
      const date = new Date(entry.date);
      const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
      months[key] = (months[key] || 0) + parseFloat(entry.hours);
    });

    // Sort by date and take last 6 active months or just sort keys
    const sortedKeys = Object.keys(months).sort();
    return sortedKeys.map(key => {
      const [year, month] = key.split('-');
      const label = new Date(parseInt(year), parseInt(month) - 1).toLocaleString('default', { month: 'short', year: '2-digit' });
      return { label, hours: months[key] };
    });
  };

  const chartData = getChartData();
  const maxHours = Math.max(...chartData.map(d => d.hours), 1); // Avoid div by zero

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      {/* Notification Toast */}
      {notification && (
        <div className="fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce-in">
          {notification}
        </div>
      )}

      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <div className="bg-indigo-600 p-2 rounded-lg">
              <Clock className="text-white w-6 h-6" />
            </div>
            <div>
              <h1 className="text-xl font-bold text-slate-900">ServiceLog</h1>
              <p className="text-xs text-slate-500 hidden sm:block">Track your impact</p>
            </div>
          </div>
          <div className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-full font-semibold text-sm flex items-center">
            <span className="mr-1">Total:</span>
            <span className="text-lg">{totalHours}</span>
            <span className="ml-1 text-xs uppercase tracking-wide">hrs</span>
          </div>
        </div>
      </header>

      {/* Navigation Tabs */}
      <div className="max-w-4xl mx-auto px-4 py-6">
        <div className="flex p-1 space-x-1 bg-slate-200/60 rounded-xl mb-6">
          <button
            onClick={() => setView('log')}
            className={`flex-1 flex items-center justify-center py-2.5 text-sm font-medium rounded-lg transition-all ${
              view === 'log' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'
            }`}
          >
            <Plus className="w-4 h-4 mr-2" />
            Log Hours
          </button>
          <button
            onClick={() => setView('history')}
            className={`flex-1 flex items-center justify-center py-2.5 text-sm font-medium rounded-lg transition-all ${
              view === 'history' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'
            }`}
          >
            <Calendar className="w-4 h-4 mr-2" />
            History
          </button>
          <button
            onClick={() => setView('stats')}
            className={`flex-1 flex items-center justify-center py-2.5 text-sm font-medium rounded-lg transition-all ${
              view === 'stats' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50'
            }`}
          >
            <PieChart className="w-4 h-4 mr-2" />
            Reports
          </button>
        </div>

        {/* --- LOG VIEW --- */}
        {view === 'log' && (
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
            <div className="p-6 border-b border-slate-100">
              <h2 className="text-lg font-semibold text-slate-800">
                {editingId ? 'Edit Entry' : 'New Service Entry'}
              </h2>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
              {/* Top Row: Date & Hours */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-slate-700">Date</label>
                  <div className="relative">
                    <input
                      type="date"
                      name="date"
                      required
                      value={formData.date}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                    />
                    <Calendar className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-slate-700">Hours</label>
                  <div className="relative">
                    <input
                      type="number"
                      step="0.25"
                      name="hours"
                      required
                      min="0"
                      placeholder="0.0"
                      value={formData.hours}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                    />
                    <Clock className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                  </div>
                </div>
              </div>

              {/* Middle Row: Type & Org */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-slate-700">Description</label>
                  <div className="relative">
                    <input
                      type="text"
                      name="type"
                      required
                      list="type-options"
                      placeholder="e.g. Served food, Cleaned up..."
                      value={formData.type}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                    />
                    <datalist id="type-options">
                      {typeSuggestions.map((t, i) => <option key={i} value={t} />)}
                    </datalist>
                    <Briefcase className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-slate-700">Organization</label>
                  <div className="relative">
                    <input
                      type="text"
                      name="org"
                      required
                      list="org-options"
                      placeholder="e.g. Saint Bernadette"
                      value={formData.org}
                      onChange={handleInputChange}
                      className="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all outline-none"
                    />
                    <datalist id="org-options">
                      {orgSuggestions.map((o, i) => <option key={i} value={o} />)}
                    </datalist>
                    <User className="absolute left-3 top-3.5 text-slate-400 w-5 h-5" />
                  </div>
                </div>
              </div>

              {/* Supervisors */}
              <div className="space-y-3">
                <label className="block text-sm font-medium text-slate-700">Supervisor</label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {supervisors.map((sup) => (
                    <div 
                      key={sup.email}
                      onClick={() => handleSupervisorSelect(sup.email)}
                      className={`relative cursor-pointer p-4 rounded-xl border-2 transition-all ${
                        formData.supervisor === sup.email 
                          ? 'border-indigo-500 bg-indigo-50' 
                          : 'border-slate-100 bg-slate-50 hover:border-indigo-200'
                      }`}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-semibold text-slate-900">{sup.name}</p>
                          {/* Label removed as requested */}
                          <p className="text-sm text-slate-600 break-all mt-1">{sup.email}</p>
                        </div>
                        {formData.supervisor === sup.email && (
                          <div className="bg-indigo-500 text-white rounded-full p-1">
                            <Check className="w-4 h-4" />
                          </div>
                        )}
                      </div>
                      
                      <button 
                        type="button"
                        onClick={(e) => {
                          e.stopPropagation();
                          copyToClipboard(sup.email);
                        }}
                        className="mt-3 flex items-center text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                      >
                        {copiedEmail === sup.email ? (
                          <>
                            <Check className="w-3 h-3 mr-1" /> Copied
                          </>
                        ) : (
                          <>
                            <Copy className="w-3 h-3 mr-1" /> Copy Email
                          </>
                        )}
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              {/* Submit Button */}
              <div className="pt-4">
                <button
                  type="submit"
                  className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center justify-center"
                >
                  {editingId ? (
                    <>
                      <Save className="w-5 h-5 mr-2" /> Update Entry
                    </>
                  ) : (
                    <>
                      <Plus className="w-5 h-5 mr-2" /> Log Hours
                    </>
                  )}
                </button>
                {editingId && (
                  <button
                    type="button"
                    onClick={() => {
                      setEditingId(null);
                      setFormData({
                        id: '',
                        type: '',
                        hours: '',
                        date: new Date().toISOString().split('T')[0],
                        org: 'Saint Bernadette Catholic Church',
                        supervisor: supervisors[0].email
                      });
                    }}
                    className="w-full mt-3 text-slate-500 font-medium py-2 hover:text-slate-800"
                  >
                    Cancel Edit
                  </button>
                )}
              </div>
            </form>
          </div>
        )}

        {/* --- HISTORY VIEW --- */}
        {view === 'history' && (
          <div className="space-y-4 animate-fade-in">
            {entries.length === 0 ? (
              <div className="text-center py-12 bg-white rounded-2xl border border-slate-200">
                <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Calendar className="text-slate-300 w-8 h-8" />
                </div>
                <p className="text-slate-500 text-lg">No hours logged yet.</p>
                <button onClick={() => setView('log')} className="mt-4 text-indigo-600 font-medium hover:underline">
                  Log your first entry
                </button>
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-slate-50 border-b border-slate-200">
                      <tr>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Date</th>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Details</th>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Hours</th>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Actions</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {entries
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .map((entry) => (
                        <tr key={entry.id} className="hover:bg-slate-50 transition-colors">
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                            {formatDate(entry.date)}
                          </td>
                          <td className="px-6 py-4">
                            <p className="text-sm font-semibold text-slate-800">{entry.type}</p>
                            <p className="text-xs text-slate-500">{entry.org}</p>
                            <p className="text-xs text-indigo-600 mt-0.5">
                              {supervisors.find(s => s.email === entry.supervisor)?.name}
                            </p>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-900 text-right">
                            {parseFloat(entry.hours).toFixed(2)}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <button 
                              onClick={() => handleEdit(entry)}
                              className="text-indigo-600 hover:text-indigo-900 p-2 rounded-full hover:bg-indigo-50 mr-2 transition-colors"
                              title="Edit"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                            <button 
                              onClick={() => handleDelete(entry.id)}
                              className="text-rose-500 hover:text-rose-700 p-2 rounded-full hover:bg-rose-50 transition-colors"
                              title="Delete"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        )}

        {/* --- STATS & EXPORT VIEW --- */}
        {view === 'stats' && (
          <div className="space-y-6 animate-fade-in">
            
            {/* Big Stat Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg shadow-indigo-200 relative overflow-hidden">
                <div className="relative z-10">
                  <p className="text-indigo-100 font-medium mb-1">Total Service</p>
                  <h3 className="text-4xl font-bold">{totalHours} <span className="text-xl font-normal text-indigo-200">hours</span></h3>
                </div>
                <Clock className="absolute right-4 bottom-4 text-indigo-500 w-24 h-24 opacity-20" />
              </div>

              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center items-center text-center">
                <p className="text-slate-500 font-medium mb-2">Entries Logged</p>
                <h3 className="text-4xl font-bold text-slate-800">{entries.length}</h3>
                <p className="text-xs text-slate-400 mt-1">Keep it up!</p>
              </div>
            </div>

            {/* Chart Section */}
            {chartData.length > 0 && (
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex justify-between items-end mb-6">
                  <h3 className="text-lg font-bold text-slate-800 flex items-center">
                    <TrendingUp className="w-5 h-5 mr-2 text-indigo-600" />
                    Monthly Activity
                  </h3>
                </div>
                
                {/* Custom CSS/SVG Bar Chart */}
                <div className="h-64 w-full flex items-end justify-between space-x-2 sm:space-x-4 pb-2">
                  {chartData.map((data, i) => {
                    const heightPercent = (data.hours / maxHours) * 100;
                    return (
                      <div key={i} className="flex-1 flex flex-col items-center group">
                        <div className="relative w-full flex items-end justify-center h-full">
                          {/* Tooltip */}
                          <div className="absolute -top-8 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 text-white text-xs py-1 px-2 rounded mb-1 whitespace-nowrap z-10">
                            {data.hours} hrs
                          </div>
                          {/* Bar */}
                          <div 
                            className="w-full max-w-[40px] bg-indigo-200 group-hover:bg-indigo-500 rounded-t-lg transition-all duration-500 ease-out relative"
                            style={{ height: `${heightPercent}%` }}
                          >
                          </div>
                        </div>
                        <span className="text-xs text-slate-500 mt-2 font-medium truncate w-full text-center">
                          {data.label}
                        </span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Export Section */}
            <div className="bg-slate-100 p-6 rounded-2xl border border-slate-200">
              <div className="flex flex-col sm:flex-row justify-between items-center">
                <div className="mb-4 sm:mb-0">
                  <h3 className="text-lg font-bold text-slate-800">Data Export</h3>
                  <p className="text-sm text-slate-500">Download your data for spreadsheet apps (Excel, Sheets).</p>
                </div>
                <button
                  onClick={exportCSV}
                  className="bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 font-semibold py-3 px-6 rounded-xl shadow-sm transition-all flex items-center"
                >
                  <Download className="w-4 h-4 mr-2" />
                  Download CSV
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
